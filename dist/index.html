<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://i.loli.net/2019/05/23/5ce65c6a0153242368.png" type="image/x-icon" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic|Material+Icons">
    <link rel="stylesheet" href="https://unpkg.com/vue-material/dist/vue-material.min.css">
    <link rel="stylesheet" href="https://unpkg.com/vue-material/dist/theme/default.css">
    <link rel="stylesheet" type="text/css" href="./main.css">
    <title>COStreamJS-v0.8.2</title>
    <style> .md-snackbar{ max-height: none!important;} </style>
</head>

<body>
    <div id="editor" style="position: absolute;top: 0; bottom: 0;left: 0;width:400px;">
    </div>

    <div id="app" style="position:absolute;top:0;left:420px;width:500px;" data-app
        class="application application--light">
        <section class="buttons">
            <md-button class="md-raised md-primary" @click="updateSVG">打印语法树</md-button>
            <md-button class="md-raised md-primary" disabled>AST->SSG</md-button>
            <md-button class="md-raised md-primary" disabled>工作量估计</md-button>
            <md-button class="md-raised md-primary" disabled>调度</md-button>
            <md-button class="md-raised md-primary" disabled>流图划分</md-button>
            <md-button class="md-raised md-primary" disabled>打印加速比</md-button>
            <md-button class="md-raised md-primary" disabled>阶段赋值</md-button>
            <md-button class="md-raised md-primary" :disabled="status!=0" @click="onAll">一键编译</md-button>
            <md-button class="md-raised md-primary" :disabled="status!=1" @click="updateSDF">画SDF图</md-button>
            <md-button class="md-raised md-accent" :disabled="status==0" @click="onToggleTargetCode">{{status==1?'查看目标代码':'查看源码'}}</md-button>
            <md-button class="md-raised md-accent" :disabled="status!=2" @click="onRunTargetCode">运行目标代码</md-button>
            <transition>
                <md-button class="md-raised md-primary" v-show="isDOT" @click="updateDOT">渲染dot</md-button>
            </transition>
        </section>

        <md-table md-card>
            <md-table-toolbar>
                <h1 class="md-title">FlatNodes</h1>
            </md-table-toolbar>
            <md-table-row>
                <md-table-head md-numeric>NAME</md-table-head>
                <md-table-head>工作量</md-table-head>
                <md-table-head>调度次数</md-table-head>
                <md-table-head>划分核号</md-table-head>
                <md-table-head>阶段号</md-table-head>
            </md-table-row>

            <md-table-row v-for="flat in flats" :key="flat.name" :class="{ 'row-grey' : flat.stageNum%2 }">
                <md-table-cell md-numeric>{{flat.name}}</md-table-cell>
                <md-table-cell>{{flat.workEstimate}}</md-table-cell>
                <md-table-cell>{{flat.steadyCount}}</md-table-cell>
                <md-table-cell :style="'background:'+coreNum2Color(flat.coreNum)">{{flat.coreNum}}</md-table-cell>
                <md-table-cell>{{flat.stageNum}}</md-table-cell>
            </md-table-row>
        </md-table>
        <md-snackbar md-position="left" :md-active.sync="showSnackbar" md-persistent>
            <span v-html="snackBarMessage"></span>
            <md-button class="md-primary" @click="showSnackbar = false">ㄨ</md-button>
        </md-snackbar>

        <md-table md-card>
            <md-table-toolbar>
                <h1 class="md-title">当前作用域</h1>
            </md-table-toolbar>
            <md-table-row>
                <md-table-head md-numeric>NAME</md-table-head>
                <md-table-head>变量</md-table-head>
            </md-table-row>
            <md-table-row v-for="id in symbol_table.idTable" :key="id">
                <md-table-cell md-numeric>{{id}}</md-table-cell>
            </md-table-row>
            <md-table-row v-for="id in symbol_table.compTable" :key="id">
                <md-table-cell md-numeric>{{id}}</md-table-cell>
            </md-table-row>
        </md-table>

        <md-table md-card>
            <md-table-toolbar>
                <h1 class="md-title">composite</h1>
            </md-table-toolbar>
            <md-table-row v-for="id in symbol_table.compTable" :key="id">
                <md-table-cell md-numeric>{{id}}</md-table-cell>
            </md-table-row>
        </md-table>
    </div>

    <!-- 右边 dot 图部分 -->
    <div id="container" style="position: absolute;top: 0; bottom: 0;left: 900px;">
        <div id="ast-svg"></div>
    </div>

    <script src="./COStreamJS.js"></script>
    <script src="./data.js"></script>
    <script src="https://cdn.bootcss.com/vue/2.6.10/vue.js"></script>
    <script src="https://cdn.bootcss.com/ace/1.4.4/ace.js"></script>
    <script src="https://cdn.bootcss.com/viz.js/2.1.2/viz.js"></script>
    <script src="https://cdn.bootcss.com/viz.js/2.1.2/lite.render.js"></script>
    <script>
        window.renderDot = async function (str) {
            var viz = new Viz();
            try {
                var astSvg = await viz.renderSVGElement(str)
                astSvg.id = "ast-svg"
                document.querySelector("#container").replaceChild(astSvg, document.getElementById("ast-svg"))
                document.querySelector("#container svg polygon").setAttribute('fill', '#fafafa')
            } catch (error) {
                console.error(error);
                console.log("要渲染的 dot 字符串内容为", str)
            }
        }
    </script>
    <script src="https://cdn.bootcss.com/axios/0.19.0/axios.min.js"></script>
    <script>
        let old_code = '';
        var editor = ace.edit("editor");
        //editor.setTheme("ace/theme/twilight");
        editor.setTheme("ace/theme/tomorrow_night_eighties");
        editor.session.setMode("ace/mode/c_cpp");
        editor.session.setUseWrapMode(true);
        editor.session.on('change', function (delta) {
            var str = editor.getValue();
            window.app.isDOT = /^\s*digraph/.test(str)
        });
        if (!window.str) {
            var url = 'https://raw.githubusercontent.com/DML308/COStreamJS/master/examples/multiOutputs.cos'
            editor.session.setValue(`//...正在加载` + url);
            window.onload = function () {
                axios.get('https://raw.githubusercontent.com/DML308/COStreamJS/master/examples/multiOutputs.cos').then(res => {
                    window.str = res.data
                    showCode(window.str);
                })
            }
        } else {
            showCode(str);
        }
        function showCode(str, type = "ace/mode/c_cpp") {
            editor.session.setMode(type);
            editor.session.setValue(str);
        }

        editor.selection.on('changeCursor', function (e) {
            if (window.app.status != 2 && editor.getValue() != str) {
                window.app.status = 0;
            }
            /* 符号表相关代码 */
            /*
            let current_line = editor.getCursorPosition().row + 1;
            let symbol_table = window.COStreamJS.SymbolTable.FindRightSymbolTable(current_line, COStreamJS.S);
            let print_table = symbol_table.printSymbol();
            Vue.set(app._data.symbol_table, 'compTable', print_table.compTable);
            Vue.set(app._data.symbol_table, 'idTable', print_table.idTable); */
        });

    </script>

    <script src="https://cdn.staticfile.org/stylus/0.32.1/stylus.min.js"></script>
    <script src="https://unpkg.com/vue-material"></script>
    <script>
        Vue.use(VueMaterial.default)

        var app = new Vue({
            el: '#app',
            data() {
                return {
                    flats: [],
                    isDOT: false,
                    showSnackbar: false,
                    snackBarMessage: '',
                    symbol_table: {},
                    status: 0 // 0: 未编译, 1: 已编译的源码状态 2:已编译的目标代码状态
                }
            },
            methods: {
                onAll() {
                    var str = editor.getValue()
                    old_code = str;
                    try {
                        COStreamJS.options.platform = 'WEB'
                        window.COStreamJS.main(str)
                        this.flats = COStreamJS.ssg.flatNodes
                        this.flats.forEach(flat => {
                            Vue.set(flat, 'workEstimate', COStreamJS.ssg.mapSteadyWork2FlatNode.get(flat))
                            Vue.set(flat, 'coreNum', COStreamJS.mp.FlatNode2PartitionNum.get(flat))
                        })
                        this.status = 1
                    } catch (err) {
                        console.warn(err)
                        this.snackBarMessage = err
                        this.showSnackbar = true
                    }
                },
                async updateSDF() {
                    var dotStr = COStreamJS.DumpStreamGraph(COStreamJS.ssg, COStreamJS.mp)
                    await window.renderDot(dotStr)
                },
                coreNum2Color(num) {
                    return ['#f2f8ff', '#f6ebd8', '#aaca3e', '#b1fbd5'][num]
                },
                async updateSVG() {
                    try {
                        str = editor.getValue()
                        window.ast = COStreamJS.parser.parse(str)
                        var dotStr = ast2dot(ast)
                        await window.renderDot(dotStr)
                    } catch (err) {
                        console.warn(err)
                        this.snackBarMessage = err
                        this.showSnackbar = true
                    }
                },
                async updateDOT() {
                    await window.renderDot(editor.getValue())
                },
                onToggleTargetCode() {
                    if (this.status == 1) {
                        showCode(COStreamJS.files["main.cpp"], "ace/mode/javascript");
                        editor.getSession().foldAll()
                        this.status = 2
                    } else if (this.status == 2) {
                        showCode(old_code)
                        this.status = 1
                    }
                },
                onRunTargetCode() {
                    hackerConsoleLog.isDebugging = true
                    try {
                        eval(editor.getValue());
                        hackerConsoleLog.flush()
                    } catch (err) {
                        console.warn(err)
                        this.snackBarMessage = err
                        this.showSnackbar = true
                    }
                    hackerConsoleLog.isDebugging = false
                }
            }
        })

        hackerConsoleLog.isDebugging = false
        hackerConsoleLog.cachedMessages = []
        hackerConsoleLog.originLog = console.log
        /** 输出缓存的控制台信息 */
        hackerConsoleLog.flush = function flush(){
            window.app.snackBarMessage = ("控制台输出结果:\n" + hackerConsoleLog.cachedMessages.join('')).replace(/\n/g, '<br>')
            window.app.showSnackbar = true
            hackerConsoleLog.cachedMessages = []
        }
        function hackerConsoleLog(...args) {
            if (hackerConsoleLog.isDebugging) {
                hackerConsoleLog.cachedMessages = hackerConsoleLog.cachedMessages.concat(args)
            }
            hackerConsoleLog.originLog.apply(console, args)
        }
        console.log = hackerConsoleLog
    </script>
</body>

</html>