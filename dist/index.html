<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://i.loli.net/2019/05/23/5ce65c6a0153242368.png" type="image/x-icon" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,400italic|Material+Icons">
    <link rel="stylesheet" href="https://unpkg.com/vue-material/dist/vue-material.min.css">
    <link rel="stylesheet" href="https://unpkg.com/vue-material/dist/theme/default.css">
    <link rel="stylesheet" type="text/css" href="./main.css">
    <title>COStreamJS-v0.4.0</title>
</head>

<body>
    <div id="editor" style="position: absolute;top: 0; bottom: 0;left: 0;width:400px;">
    </div>

    <div id="app" style="position:absolute;top:0;left:420px;width:500px;" data-app class="application application--light">
        <section class="buttons">
            <md-button class="md-raised md-primary" @click="updateSVG">打印语法树</md-button>
            <md-button class="md-raised md-primary" disabled>AST->SSG</md-button>
            <md-button class="md-raised md-primary" disabled>工作量估计</md-button>
            <md-button class="md-raised md-primary" disabled>调度</md-button>
            <md-button class="md-raised md-primary" disabled>流图划分</md-button>
            <md-button class="md-raised md-primary" disabled>打印加速比</md-button>
            <md-button class="md-raised md-primary" disabled>阶段赋值</md-button>
            <md-button class="md-raised md-primary" @click="onAll">一键执行</md-button>
            <md-button class="md-raised md-primary" @click="updateSDF">画SDF图</md-button>
            <transition>
                <md-button class="md-raised md-primary" v-show="isDOT" @click="updateDOT">渲染dot</md-button>
            </transition>
        </section>

        <md-table md-card>
            <md-table-toolbar>
                <h1 class="md-title">FlatNodes</h1>
            </md-table-toolbar>
            <md-table-row>
                <md-table-head md-numeric>NAME</md-table-head>
                <md-table-head>工作量</md-table-head>
                <md-table-head>调度次数</md-table-head>
                <md-table-head>划分核号</md-table-head>
                <md-table-head>阶段号</md-table-head>
            </md-table-row>

            <md-table-row v-for="flat in flats" :key="flat.name" :class="{ 'row-grey' : flat.stageNum%2 }">
                <md-table-cell md-numeric>{{flat.name}}</md-table-cell>
                <md-table-cell>{{flat.workEstimate}}</md-table-cell>
                <md-table-cell>{{flat.steadyCount}}</md-table-cell>
                <md-table-cell :style="'background:'+coreNum2Color(flat.coreNum)">{{flat.coreNum}}</md-table-cell>
                <md-table-cell>{{flat.stageNum}}</md-table-cell>
            </md-table-row>
        </md-table>
        <md-snackbar md-position="left" :md-active.sync="showSnackbar"
            md-persistent>
            <span>{{snackBarMessage}}</span>
            <md-button class="md-primary" @click="showSnackbar = false">ㄨ</md-button>
        </md-snackbar>

        <md-table md-card>
            <md-table-toolbar>
                <h1 class="md-title">当前作用域</h1>
            </md-table-toolbar>
            <md-table-row>
                <md-table-head md-numeric>NAME</md-table-head>
            </md-table-row>
            <md-table-cell >变量</md-table-cell>
            <md-table-row v-for="id in symbol_table.idTable" :key="id">
                <md-table-cell md-numeric>{{id}}</md-table-cell>
            </md-table-row>
            <md-table-cell >composite</md-table-cell>
            <md-table-row v-for="id in symbol_table.compTable" :key="id">
                <md-table-cell md-numeric>{{id}}</md-table-cell>
            </md-table-row>
        </md-table>
    </div>

    <!-- 右边 dot 图部分 -->
    <div id="container" style="position: absolute;top: 0; bottom: 0;left: 900px;">
        <div id="ast-svg"></div>
    </div>

    <script src="./COStreamJS.js"></script>
    <script src="./data.js"></script>
    <script src="https://cdn.bootcss.com/vue/2.6.10/vue.js"></script>
    <script src="https://cdn.bootcss.com/ace/1.4.4/ace.js"></script>
    <script src="https://cdn.bootcss.com/viz.js/2.1.2/viz.js"></script>
    <script src="https://cdn.bootcss.com/viz.js/2.1.2/lite.render.js"></script>
    <script>
        window.renderDot = async function (str) {
            var viz = new Viz();
            try {
                var astSvg = await viz.renderSVGElement(str)
                astSvg.id = "ast-svg"
                document.querySelector("#container").replaceChild(astSvg, document.getElementById("ast-svg"))
                document.querySelector("#container svg polygon").setAttribute('fill', '#fafafa')
            } catch (error) {
                console.error(error);
                console.log("要渲染的 dot 字符串内容为", str)
            }
        }
    </script>
    <script src="https://cdn.bootcss.com/axios/0.19.0/axios.min.js"></script>
    <script>
        let old_code = '';
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/tomorrow");
        editor.session.setMode("ace/mode/c_cpp");
        editor.session.setUseWrapMode(true);
        editor.session.on('change', function (delta) {
            var str = editor.getValue();
            window.app.isDOT = /^\s*digraph/.test(str)
        });
        if (!window.str) {
            var url = 'https://raw.githubusercontent.com/DML308/COStreamJS/master/examples/multiOutputs.cos'
            editor.session.setValue(`//...正在加载` + url);
            window.onload = function () {
                axios.get('https://raw.githubusercontent.com/DML308/COStreamJS/master/examples/multiOutputs.cos').then(res => editor.session.setValue(res.data))
            }
        } else {
            editor.session.setValue(str);
        }
        editor.selection.on('changeCursor', function(e) {
            if(editor.getValue()!==old_code){
                return;
            }
            let current_line = editor.getCursorPosition().row+1;
            let symbol_table = window.COStreamJS.SymbolTable.FindRightSymbolTable(current_line,COStreamJS.S);
            let print_table = symbol_table.printSymbol();
            Vue.set(app._data.symbol_table,'compTable',print_table.compTable);
            Vue.set(app._data.symbol_table,'idTable',print_table.idTable);
        });

    </script>

    <script src="https://cdn.staticfile.org/stylus/0.32.1/stylus.min.js"></script>
    <script src="https://unpkg.com/vue-material"></script>
    <script>
        Vue.use(VueMaterial.default)

        var app = new Vue({
            el: '#app',
            data() {
                return {
                    flats: [],
                    isDOT: false,
                    showSnackbar:false,
                    snackBarMessage:'',
                    symbol_table:{},
                }
            },
            methods: {
                onAll() {
                    var str = editor.getValue()
                    old_code = str;
                    try{
                        window.COStreamJS.main(str)
                        this.flats = COStreamJS.ssg.flatNodes
                        this.flats.forEach(flat => {
                            Vue.set(flat, 'workEstimate', COStreamJS.ssg.mapSteadyWork2FlatNode.get(flat))
                            Vue.set(flat, 'coreNum', COStreamJS.mp.FlatNode2PartitionNum.get(flat))
                        })
                    }catch(err){
                        console.warn(err)
                        this.snackBarMessage = err
                        this.showSnackbar = true
                    }
                },
                async updateSDF() {
                    var dotStr = COStreamJS.DumpStreamGraph(COStreamJS.ssg, COStreamJS.mp)
                    await window.renderDot(dotStr)
                },
                coreNum2Color(num) {
                    return ['#f2f8ff', '#f6ebd8', '#aaca3e', '#b1fbd5'][num]
                },
                async updateSVG() {
                    try {
                        str = editor.getValue()
                        window.ast = COStreamJS.parser.parse(str)
                        var dotStr = ast2dot(ast)
                        await window.renderDot(dotStr)
                    } catch (err) {
                        console.warn(err)
                        this.snackBarMessage = err
                        this.showSnackbar = true
                    }
                },
                async updateDOT() {
                    await window.renderDot(editor.getValue())
                },
            }
        })
    </script>
</body>

</html>